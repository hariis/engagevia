<div id="right"> 
  <%= render :partial => 'posts/sticky_note' %>  
  <div id="participants">
    <h3 style="border-bottom:1px solid #fff;"><%= image_tag "group.png" %>Participants <span id="participant-count">(<%= @post.engagements.size %>)</span></h3>

    <ul id="participants-list">
    <% unless @post.engagements.empty? %>
        <% @post.engagements.each do |engagement| %>
        <% if engagement.invitee.id == @user.id  %>
        <li id='you'><%= image_tag "user_red.png" %> Me
          <span id="notify-option">
               <% if engagement.notify_me? %>
                  <%= image_tag "email.png", :id => "enabled" %><%= image_tag "email_delete.png", :id => "disabled" , :style => "display:none;" %>
               <% else %>
                  <%= image_tag "email.png", :id => "enabled", :style => "display:none;" %><%= image_tag "email_delete.png", :id => "disabled"  %>
               <% end %>              
          </span>
                
              
        <% else %>         

        <% if engagement.invitee.member? %>
          <li><%= image_tag "user_green.png" %> <%=  engagement.invitee.display_name(nil,engagement).titleize %>
        <% else %>
          <li><%= image_tag "user_green.png" %> <%=  engagement.invitee.display_name(nil,engagement).titleize %>
        <% end  %>
                  

        <% end  %>  
           <!-- common to both -->
              <%= link_to_function( (image_tag ("bullet_arrow_down.png")),  :id => "more_link_down_#{engagement.invitee.id}") do |page|
                      page.visual_effect  :toggle_blind, "user-details_#{engagement.invitee.id}"
                      page.show "more_link_up_#{engagement.invitee.id}"
                      page.hide "more_link_down_#{engagement.invitee.id}"
                      #page.replace_html 'more_link', "#{image_tag "bullet_arrow_up.png"}"
               end  %>
              <%= link_to_function( (image_tag ("bullet_arrow_up.png")),  :id => "more_link_up_#{engagement.invitee.id}", :style => 'display:none;') do |page|
                      page.visual_effect  :toggle_blind, "user-details_#{engagement.invitee.id}"
                      page.hide "more_link_up_#{engagement.invitee.id}"
                      page.show "more_link_down_#{engagement.invitee.id}"
               end  %>
            <div id="user-details_<%=engagement.invitee.id %>"  style="display:none;">
                    <% if engagement.invitee.avatar.file? %>
                      <%= image_tag engagement.invitee.avatar.url(:thumb) %>
                    <% else %>
                      No photo available
                   <% end %>
                      <% if @post.owner.id == @user.id && engagement.invitee.id != @user.id %>
                          <div id="resend_<%= engagement.invitee.id %>" style="float:right;margin-bottom:10px;">
                              <%= button_to_remote 'Resend Invite', :url => {:controller => 'engagements', :action => 'resend_invite', :id => engagement.id, :post_id => @post.id} %>
                           </div>
                      <% end %>
                      <% if engagement.invitee.id == @user.id  %>
                            <div id="notification" style="float:right;margin-bottom:10px;">
                                <% if engagement.notify_me? %>
                                  <%= button_to_remote 'Disable Notification', :url => {:controller => 'engagements', :action => 'set_notification', :id => engagement.id, :set => 'false'} %>
                                <% else %>
                                  <%= button_to_remote 'Enable Notification', :url => {:controller => 'engagements', :action => 'set_notification', :id => engagement.id, :set => 'true'} %>
                               <% end %>
                           </div>
                       <% end %>
                    <div class ="user-bio">
                        <b>Twitter Profile:</b><br/>                         
                         <%= engagement.invitee.screen_name.blank? ? "" : "http://twitter.com/" + engagement.invitee.screen_name %><br/>
                        <b>Blog:</b><br/>
                        <%=h engagement.invitee.blog_link %><br/>
                        <b>Facebook Profile:</b><br/>
                        <%=h engagement.invitee.facebook_link %><br/>
                        <b>LinkedIn Profile:</b><br/>
                        <%=h engagement.invitee.linked_in_link %><br/>

                    </div>
             </div>
        </li>
       <% end %>
    <%  end %>
    </ul>

  </div>

   <div id="invitations">
      <strong style="float:left;">Invitations sent:</strong><br/>
    <% engagements = Engagement.find(:all,:conditions => ["post_id = ?", @post.id]) %>
    <% if engagements.size > 1 %>
          <% engagements_by_invite = engagements.group_by { |t| t.invited_by } if engagements %>
          <% if engagements_by_invite %>
              <ul>
                <% engagements_by_invite.sort.each do |invited_by, engagements| %>
                      <li>
                        <% inviter = User.find(invited_by) %>
                        <span class="inviter"><%= inviter.id == @user.id ? "I" : inviter.display_name %> invited</span> <br/>
                        <% invitees = [] %>
                        <% engagements_by_date = engagements.group_by { |t| t.invited_when } if engagements %>
                        <% engagements_by_date.sort.each do |invited_when, engagements| %>
                        <% engagements.each do |engagement| %>
                            <% invitee = User.find(engagement.user_id) %>
                            <% invitees << invitee.display_name(nil,engagement) if @post.owner.id != invitee.id %>
                        <% end %>
                        <% if invitees.length > 0 %>
                        <span class="invitees">
                        <%= invitees.join(", ") %> <%= distance_of_time_in_words(@post.created_at.utc, invited_when.utc) + " later" %></span> <br/>
                        <% invitees = [] %>
                        <% end %>
                        <% end %>
                      </li>

                <% end %>
              </ul>
          <% end %>
     <% else %>
        No one has been invited yet.
    <% end %>
    </div>
</div>
